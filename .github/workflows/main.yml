name: Build and Deploy Docker App to EC2

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY: my-simple-app
  EC2_INSTANCE_ID: i-094508a1d35db13df
  APP_PORT: 8090

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS credentials for GitHub Actions
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3ï¸âƒ£ Log in to Amazon ECR from GitHub Actions
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4ï¸âƒ£ Build, tag, and push Docker image to ECR
      - name: Build, tag, and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: latest
        run: |
          echo "ðŸ”¹ Building Docker image..."
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
          echo "ðŸ”¹ Pushing Docker image to ECR..."
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      # 5ï¸âƒ£ Get EC2 public IP dynamically
      - name: Get EC2 Public IP
        id: ec2ip
        run: |
          EC2_PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_PUBLIC_IP=$EC2_PUBLIC_IP" >> $GITHUB_ENV
          echo "Public IP: $EC2_PUBLIC_IP"

      # 6ï¸âƒ£ Wait for EC2 to be ready
      - name: Wait for EC2 instance to be ready
        run: |
          echo "Waiting for EC2 instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids ${{ env.EC2_INSTANCE_ID }}

      # 7ï¸âƒ£ SSH into EC2 and deploy container with AWS creds
      - name: SSH into EC2 and deploy container
        run: |
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@${{ env.EC2_PUBLIC_IP }} <<EOF
          set -e
          
          # âœ… Pass AWS credentials to EC2
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_DEFAULT_REGION="eu-north-1"
          
          # Login to ECR
          ECR_REGISTRY=\$(aws ecr describe-repositories --repository-names my-simple-app --query "repositories[0].repositoryUri" --output text)
          aws ecr get-login-password | sudo docker login --username AWS --password-stdin \$ECR_REGISTRY
          
          # Stop old container and remove image
          sudo docker stop my-simple-app || true
          sudo docker rm my-simple-app || true
          sudo docker image rm \$ECR_REGISTRY:latest || true
          
          # Pull new image and run
          sudo docker pull \$ECR_REGISTRY:latest
          sudo docker run -d --name my-simple-app -p 8090:80 \$ECR_REGISTRY:latest
          
          echo "âœ… Deployment complete."
          EOF

      # 8ï¸âƒ£ Health check
      - name: Health check
        run: |
          echo "ðŸ”Ž Performing health check..."
          sleep 10
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.EC2_PUBLIC_IP }}:${{ env.APP_PORT }})
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… App is live and responding at: http://${{ env.EC2_PUBLIC_IP }}:${{ env.APP_PORT }}"
          else
            echo "âŒ Health check failed (HTTP $RESPONSE)"
            exit 1
          fi
