name: Build and Deploy Docker App to EC2

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY: my-simple-app
  EC2_INSTANCE_ID: i-094508a1d35db13df
  APP_PORT: 8090

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3ï¸âƒ£ Log in to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4ï¸âƒ£ Build, tag, and push image to ECR
      - name: Build, tag, and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      # 5ï¸âƒ£ Get EC2 public IP dynamically
      - name: Get EC2 Public IP
        id: ec2ip
        run: |
          EC2_PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_PUBLIC_IP=$EC2_PUBLIC_IP" >> $GITHUB_ENV
          echo "Public IP: $EC2_PUBLIC_IP"

      # 6ï¸âƒ£ Wait for EC2 to be ready
      - name: Wait for EC2 instance to be ready
        run: |
          echo "Waiting for EC2 instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids ${{ env.EC2_INSTANCE_ID }}

      # 7ï¸âƒ£ SSH into EC2 and deploy container (âœ… no indentation inside EOF)
      - name: SSH into EC2 and deploy container
        run: |
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          echo "Connecting to EC2 at ${{ env.EC2_PUBLIC_IP }}..."

          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 -o ServerAliveCountMax=4 \
              -i private_key.pem ec2-user@${{ env.EC2_PUBLIC_IP }} <<'EOF'
          set -e
          echo "ðŸ”¹ Updating system..."
          sudo dnf update -y

          echo "ðŸ”¹ Installing Docker..."
          sudo dnf install -y docker
          sudo systemctl start docker
          sudo systemctl enable docker

          echo "ðŸ”¹ Logging in to Amazon ECR..."
          aws ecr get-login-password --region eu-north-1 \
            | sudo docker login --username AWS --password-stdin 456501836709.dkr.ecr.eu-north-1.amazonaws.com
          
          echo "ðŸ”¹ Cleaning up old container..."
          sudo docker stop my-simple-app || true
          sudo docker rm my-simple-app || true
          sudo docker image rm 456501836709.dkr.ecr.eu-north-1.amazonaws.com/my-simple-app:latest || true
          
          echo "ðŸ”¹ Pulling and running new container..."
          sudo docker pull 456501836709.dkr.ecr.eu-north-1.amazonaws.com/my-simple-app:latest
          sudo docker run -d --name my-simple-app -p 8090:80 456501836709.dkr.ecr.eu-north-1.amazonaws.com/my-simple-app:latest
          
          echo "âœ… Deployment complete."
          EOF

      # 8ï¸âƒ£ Health check
      - name: Health check
        run: |
          echo "ðŸ”Ž Performing health check..."
          sleep 10
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.EC2_PUBLIC_IP }}:${{ env.APP_PORT }})
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… App is live and responding at: http://${{ env.EC2_PUBLIC_IP }}:${{ env.APP_PORT }}"
          else
            echo "âŒ Health check failed (HTTP $RESPONSE)"
            exit 1
          fi
